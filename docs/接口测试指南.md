# XLHealth 后端接口测试指南

## 项目概述

- **项目名称**: XLHealth Backend
- **版本**: 1.0.0
- **基础 URL**: `http://localhost:8081`
- **API 版本**: v1
- **认证方式**: JWT Bearer Token

## 环境配置

### 服务器信息

- **端口**: 8081
- **数据库**: MySQL (localhost:3306/xlhealth)
- **时区**: Asia/Shanghai (GMT+8)

### 通用响应格式

所有接口都遵循统一的响应格式：

```json
{
  "success": true,
  "message": "操作成功",
  "data": {},
  "timestamp": "2024-01-01T12:00:00"
}
```

### 分页响应格式

```json
{
  "success": true,
  "message": "查询成功",
  "data": {
    "records": [],
    "total": 100,
    "current": 1,
    "size": 10,
    "pages": 10,
    "hasNext": true,
    "hasPrevious": false
  }
}
```

## 接口分类

### 1. 健康检查接口

#### 1.1 服务健康检查

- **接口**: `GET /api/v1/health`
- **描述**: 检查服务运行状态
- **认证**: 无需认证
- **请求参数**: 无
- **响应示例**:

```json
{
  "success": true,
  "message": "服务运行正常",
  "data": {
    "status": "UP",
    "timestamp": "2024-01-01T12:00:00",
    "application": "XLHealth Backend",
    "version": "1.0.0"
  }
}
```

#### 1.2 版本信息

- **接口**: `GET /api/v1/health/version`
- **描述**: 获取应用版本信息
- **认证**: 无需认证
- **请求参数**: 无
- **响应示例**:

```json
{
  "success": true,
  "message": "版本信息",
  "data": {
    "application": "XLHealth Backend",
    "version": "1.0.0",
    "buildTime": "2024-01-01",
    "springBootVersion": "3.5.0",
    "javaVersion": "17.0.1"
  }
}
```

### 2. 用户认证接口

#### 2.1 用户注册

- **接口**: `POST /api/v1/auth/register`
- **描述**: 用户注册
- **认证**: 无需认证
- **请求体**:

```json
{
  "username": "testuser",
  "email": "test@example.com",
  "password": "Test123456",
  "confirmPassword": "Test123456",
  "nickname": "测试用户"
}
```

- **字段验证规则**:
  - `username`: 必填，3-20 字符，只能包含字母、数字和下划线
  - `email`: 必填，有效邮箱格式
  - `password`: 必填，6-20 字符，必须包含大小写字母和数字
  - `confirmPassword`: 必填，必须与 password 一致
  - `nickname`: 可选，最多 50 字符

#### 2.2 用户登录

- **接口**: `POST /api/v1/auth/login`
- **描述**: 用户登录
- **认证**: 无需认证
- **请求体**:

```json
{
  "usernameOrEmail": "testuser",
  "password": "Test123456",
  "rememberMe": false
}
```

- **响应示例**:

```json
{
  "success": true,
  "message": "登录成功",
  "data": {
    "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "tokenType": "Bearer",
    "expiresIn": 86400,
    "userInfo": {
      "id": 1,
      "username": "testuser",
      "email": "test@example.com",
      "nickname": "测试用户",
      "avatarUrl": null,
      "status": "ACTIVE"
    }
  }
}
```

#### 2.3 用户登出

- **接口**: `POST /api/v1/auth/logout`
- **描述**: 用户登出
- **认证**: 需要 Bearer Token
- **请求头**: `Authorization: Bearer {token}`
- **请求参数**: 无

#### 2.4 刷新 Token

- **接口**: `POST /api/v1/auth/refresh`
- **描述**: 刷新访问令牌
- **认证**: 需要 Bearer Token
- **请求头**: `Authorization: Bearer {token}`
- **请求参数**: 无

#### 2.5 验证 Token

- **接口**: `GET /api/v1/auth/validate`
- **描述**: 验证令牌有效性
- **认证**: 需要 Bearer Token
- **请求头**: `Authorization: Bearer {token}`
- **请求参数**: 无

### 3. 用户管理接口

#### 3.1 获取当前用户资料

- **接口**: `GET /api/v1/users/profile`
- **描述**: 获取当前登录用户的资料信息
- **认证**: 需要 Bearer Token
- **请求头**: `Authorization: Bearer {token}`
- **响应示例**:

```json
{
  "success": true,
  "message": "获取成功",
  "data": {
    "id": 1,
    "username": "testuser",
    "email": "test@example.com",
    "nickname": "测试用户",
    "avatarUrl": "http://example.com/avatar.jpg",
    "status": "ACTIVE",
    "createdTime": "2024-01-01T12:00:00",
    "lastLoginTime": "2024-01-01T12:00:00",
    "statusDescription": "活跃"
  }
}
```

#### 3.2 更新当前用户资料

- **接口**: `PUT /api/v1/users/profile`
- **描述**: 更新当前登录用户的资料信息
- **认证**: 需要 Bearer Token
- **请求头**: `Authorization: Bearer {token}`
- **请求体**:

```json
{
  "email": "newemail@example.com",
  "nickname": "新昵称",
  "avatarUrl": "http://example.com/new-avatar.jpg"
}
```

- **字段验证规则**:
  - `email`: 可选，有效邮箱格式
  - `nickname`: 可选，1-50 字符
  - `avatarUrl`: 可选，最多 500 字符

#### 3.3 修改密码

- **接口**: `PUT /api/v1/users/password`
- **描述**: 修改当前用户密码
- **认证**: 需要 Bearer Token
- **请求头**: `Authorization: Bearer {token}`
- **请求体**:

```json
{
  "currentPassword": "OldPassword123",
  "newPassword": "NewPassword123",
  "confirmPassword": "NewPassword123"
}
```

- **字段验证规则**:
  - `currentPassword`: 必填，当前密码
  - `newPassword`: 必填，6-20 字符
  - `confirmPassword`: 必填，必须与 newPassword 一致

## Apifox 测试配置

### 1. 环境变量设置

在 Apifox 中创建环境变量：

```
baseUrl: http://localhost:8081
accessToken: (登录后获取的token)
```

### 2. 全局请求头设置

对于需要认证的接口，在 Apifox 中设置全局请求头：

```
Authorization: Bearer {{accessToken}}
Content-Type: application/json
```

### 3. 测试流程建议

#### 3.1 基础测试流程

1. **健康检查**: 先测试 `/api/v1/health` 确保服务正常
2. **用户注册**: 测试 `/api/v1/auth/register` 创建测试用户
3. **用户登录**: 测试 `/api/v1/auth/login` 获取访问令牌
4. **设置 Token**: 将获取的 token 设置到环境变量中
5. **用户资料**: 测试用户相关接口

#### 3.2 认证测试场景

- **正常登录**: 使用正确的用户名和密码
- **错误密码**: 使用错误的密码
- **不存在用户**: 使用不存在的用户名
- **Token 过期**: 使用过期的 token
- **无效 Token**: 使用格式错误的 token

#### 3.3 数据验证测试

- **必填字段**: 测试必填字段为空的情况
- **字段长度**: 测试超出长度限制的字段
- **格式验证**: 测试邮箱格式、密码强度等
- **重复数据**: 测试用户名、邮箱重复的情况

### 4.4 用户头像上传

**接口地址：** `POST /api/v1/users/avatar`

**请求参数：**

- Form 参数：
  - `file` (MultipartFile): 头像文件

**文件要求：**

- 支持格式：jpg, jpeg, png, gif
- 文件大小：最大 5MB
- 文件不能为空

**请求示例：**

```bash
curl -X POST "http://localhost:8081/api/v1/users/avatar" \
  -H "Authorization: Bearer your_jwt_token" \
  -F "file=@/path/to/avatar.jpg"
```

**响应示例：**

```json
{
  "success": true,
  "message": "头像上传成功",
  "data": {
    "avatarUrl": "/uploads/avatars/avatar_1734567890123.jpg"
  },
  "timestamp": "2024-12-19T10:30:00"
}
```

**错误响应示例：**

```json
{
  "success": false,
  "message": "不支持的文件类型",
  "timestamp": "2024-12-19T10:30:00"
}
```

**注意事项：**

- 需要用户认证
- 上传成功后会自动更新当前用户资料中的头像 URL
- 文件会保存在服务器的 `/uploads/avatars/` 目录下
- 文件名会自动生成，包含时间戳以避免冲突

---

### 4. 常见错误码

- **400**: 请求参数错误
- **401**: 未认证或认证失败
- **403**: 权限不足
- **404**: 资源不存在
- **409**: 数据冲突（如用户名已存在）
- **500**: 服务器内部错误

### 5. 测试数据准备

#### 5.1 测试用户数据

```json
{
  "username": "testuser001",
  "email": "testuser001@example.com",
  "password": "Test123456",
  "confirmPassword": "Test123456",
  "nickname": "测试用户001"
}
```

#### 5.2 无效数据示例

- 用户名过短: `"ab"`
- 密码过弱: `"123456"`
- 邮箱格式错误: `"invalid-email"`
- 密码不匹配: `confirmPassword` 与 `password` 不一致

## 注意事项

1. **JWT Token 有效期**: 默认 24 小时（86400 秒）
2. **时区设置**: 所有时间都使用 Asia/Shanghai 时区
3. **逻辑删除**: 用户删除采用逻辑删除，不会真正删除数据
4. **密码安全**: 密码必须包含大小写字母和数字
5. **数据库连接**: 确保 MySQL 服务正常运行
6. **端口冲突**: 确保 8081 端口未被占用

## 故障排查

### 1. 服务无法启动

- 检查 MySQL 服务是否运行
- 检查端口 8081 是否被占用
- 检查数据库连接配置

### 2. 认证失败

- 检查 JWT secret 配置
- 确认 token 格式正确
- 检查 token 是否过期

### 3. 数据库错误

- 检查数据库连接参数
- 确认数据库表结构正确
- 检查 Flyway 迁移是否成功

---

**文档版本**: 1.1  
**更新时间**: 2024-12-19  
**维护人员**: XLHealth 开发团队  
**更新说明**: 根据 TASK005 要求，删除了多余的管理员接口，只保留用户基本资料管理功能
